[
    {
        "id": "product-service-flows",
        "type": "tab",
        "label": "ðŸ“¦ Product Service Gateway",
        "disabled": false,
        "info": "Complete Product Service API Gateway for product management and filtering"
    },
    {
        "id": "product-get-all-endpoint",
        "type": "http in",
        "z": "product-service-flows",
        "name": "GET /api/products",
        "url": "/api/products",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 80,
        "wires": [["forward-to-products"]]
    },
    {
        "id": "forward-to-products",
        "type": "http request",
        "z": "product-service-flows",
        "name": "â†’ Get Products API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-product-1:3002/products",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 370,
        "y": 80,
        "wires": [["process-products-response"]]
    },
    {
        "id": "process-products-response",
        "type": "function",
        "z": "product-service-flows",
        "name": "Process Products Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\n\nif (isSuccess && msg.payload) {\n    let products = [];\n    \n    // Handle both old format (direct array) and new format (with data property)\n    if (Array.isArray(msg.payload)) {\n        products = msg.payload;\n    } else if (msg.payload.success && Array.isArray(msg.payload.data)) {\n        products = msg.payload.data;\n    } else {\n        products = [];\n    }\n    \n    node.log(`âœ… SUCCESS: Retrieved ${products.length} products`);\n    \n    // Update product statistics\n    let productStats = global.get('productServiceStats') || {\n        getAllRequests: 0,\n        getByIdRequests: 0,\n        filterRequests: 0,\n        errors: 0,\n        startTime: new Date().toISOString()\n    };\n    productStats.getAllRequests++;\n    global.set('productServiceStats', productStats);\n    \n    // Return products in consistent format for frontend\n    msg.payload = products;\n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Product retrieval failed - Status: ${msg.statusCode}`);\n    \n    msg.payload = {\n        success: false,\n        message: 'Failed to retrieve products',\n        error: msg.payload.error || 'Unknown error'\n    };\n    \n    // Update error statistics\n    let productStats = global.get('productServiceStats') || {\n        getAllRequests: 0,\n        getByIdRequests: 0,\n        filterRequests: 0,\n        errors: 0,\n        startTime: new Date().toISOString()\n    };\n    productStats.errors++;\n    global.set('productServiceStats', productStats);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 80,
        "wires": [["products-response"]]
    },
    {
        "id": "products-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Products Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 870,
        "y": 80,
        "wires": []
    },
    {
        "id": "product-get-by-id-endpoint",
        "type": "http in",
        "z": "product-service-flows",
        "name": "GET /api/products/:id",
        "url": "/api/products/:id",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 160,
        "wires": [["validate-product-id"]]
    },
    {
        "id": "validate-product-id",
        "type": "function",
        "z": "product-service-flows",
        "name": "Validate Product ID",
        "func": "const productId = msg.req.params.id;\n\nnode.log(`ðŸ“¦ PRODUCT REQUEST: Product ID ${productId}`);\n\n// Validate product ID\nif (!productId) {\n    node.warn(`âŒ No product ID provided`);\n    msg.statusCode = 400;\n    msg.payload = { \n        success: false,\n        message: 'Product ID is required',\n        error: 'MISSING_PRODUCT_ID'\n    };\n    return [null, msg]; // Send to error response\n}\n\nnode.log(`âœ… PRODUCT ID VALIDATION PASSED: ${productId}`);\nmsg.productId = productId;\n\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 160,
        "wires": [["forward-to-product-by-id"], ["product-error-response"]]
    },
    {
        "id": "forward-to-product-by-id",
        "type": "http request",
        "z": "product-service-flows",
        "name": "â†’ Get Product by ID API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-product-1:3002/products/{{{productId}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 600,
        "y": 140,
        "wires": [["process-product-by-id-response"]]
    },
    {
        "id": "process-product-by-id-response",
        "type": "function",
        "z": "product-service-flows",
        "name": "Process Product by ID Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\nconst productId = msg.productId || 'Unknown';\n\nif (isSuccess && msg.payload) {\n    let product = null;\n    \n    // Handle both old format (direct object) and new format (with data property)\n    if (msg.payload.success && msg.payload.data) {\n        product = msg.payload.data;\n    } else if (msg.payload._id || msg.payload.id) {\n        product = msg.payload;\n    }\n    \n    if (product) {\n        node.log(`âœ… SUCCESS: Product ${productId} retrieved - ${product.name}`);\n        \n        // Update product statistics\n        let productStats = global.get('productServiceStats') || {\n            getAllRequests: 0,\n            getByIdRequests: 0,\n            filterRequests: 0,\n            errors: 0,\n            startTime: new Date().toISOString()\n        };\n        productStats.getByIdRequests++;\n        global.set('productServiceStats', productStats);\n        \n        // Return product in consistent format\n        msg.payload = product;\n        msg.statusCode = 200;\n    } else {\n        // Handle case where product data is malformed\n        node.warn(`âŒ FAILED: Product ${productId} data malformed`);\n        msg.payload = {\n            success: false,\n            message: 'Product not found',\n            error: 'PRODUCT_NOT_FOUND',\n            productId: productId\n        };\n        msg.statusCode = 404;\n    }\n} else {\n    node.warn(`âŒ FAILED: Product ${productId} not found - Status: ${msg.statusCode}`);\n    \n    if (msg.statusCode === 404) {\n        msg.payload = {\n            success: false,\n            message: 'Product not found',\n            error: 'PRODUCT_NOT_FOUND',\n            productId: productId\n        };\n    } else {\n        msg.payload = {\n            success: false,\n            message: 'Failed to retrieve product',\n            error: msg.payload.error || 'Unknown error',\n            productId: productId\n        };\n    }\n    \n    // Update error statistics\n    let productStats = global.get('productServiceStats') || {\n        getAllRequests: 0,\n        getByIdRequests: 0,\n        filterRequests: 0,\n        errors: 0,\n        startTime: new Date().toISOString()\n    };\n    productStats.errors++;\n    global.set('productServiceStats', productStats);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 140,
        "wires": [["product-by-id-response"]]
    },
    {
        "id": "product-error-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Product Error Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 620,
        "y": 200,
        "wires": []
    },
    {
        "id": "product-by-id-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Product by ID Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1150,
        "y": 140,
        "wires": []
    },
    {
        "id": "product-filter-endpoint",
        "type": "http in",
        "z": "product-service-flows",
        "name": "GET /api/products/filter/:category",
        "url": "/api/products/filter/:category",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 260,
        "wires": [["validate-filter-category"]]
    },
    {
        "id": "validate-filter-category",
        "type": "function",
        "z": "product-service-flows",
        "name": "Validate Filter Category",
        "func": "const category = msg.req.params.category;\n\nnode.log(`ðŸ·ï¸ FILTER REQUEST: Category ${category}`);\n\n// Validate category\nif (!category) {\n    node.warn(`âŒ No category provided`);\n    msg.statusCode = 400;\n    msg.payload = { \n        success: false,\n        message: 'Category is required',\n        error: 'MISSING_CATEGORY'\n    };\n    return [null, msg]; // Send to error response\n}\n\nnode.log(`âœ… CATEGORY VALIDATION PASSED: ${category}`);\nmsg.category = category;\n\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 260,
        "wires": [["forward-to-filter"], ["filter-error-response"]]
    },
    {
        "id": "forward-to-filter",
        "type": "http request",
        "z": "product-service-flows",
        "name": "â†’ Filter Products API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-product-1:3002/filter/category/{{{category}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 650,
        "y": 240,
        "wires": [["process-filter-response"]]
    },
    {
        "id": "process-filter-response",
        "type": "function",
        "z": "product-service-flows",
        "name": "Process Filter Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\nconst category = msg.category || 'Unknown';\n\nif (isSuccess && msg.payload) {\n    let filteredProducts = [];\n    \n    // Handle both old format (direct array) and new format (with data property)\n    if (Array.isArray(msg.payload)) {\n        filteredProducts = msg.payload;\n    } else if (msg.payload.success && Array.isArray(msg.payload.data)) {\n        filteredProducts = msg.payload.data;\n    } else if (msg.payload.filteredProducts && Array.isArray(msg.payload.filteredProducts)) {\n        // Handle legacy format\n        filteredProducts = msg.payload.filteredProducts;\n    } else {\n        filteredProducts = [];\n    }\n    \n    node.log(`âœ… SUCCESS: Filter by ${category} returned ${filteredProducts.length} products`);\n    \n    // Update product statistics\n    let productStats = global.get('productServiceStats') || {\n        getAllRequests: 0,\n        getByIdRequests: 0,\n        filterRequests: 0,\n        errors: 0,\n        startTime: new Date().toISOString()\n    };\n    productStats.filterRequests++;\n    global.set('productServiceStats', productStats);\n    \n    // Return filtered products in consistent format\n    msg.payload = filteredProducts;\n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Filter by ${category} failed - Status: ${msg.statusCode}`);\n    \n    msg.payload = {\n        success: false,\n        message: `Failed to filter products by category: ${category}`,\n        error: msg.payload.error || 'Unknown error',\n        category: category\n    };\n    \n    // Update error statistics\n    let productStats = global.get('productServiceStats') || {\n        getAllRequests: 0,\n        getByIdRequests: 0,\n        filterRequests: 0,\n        errors: 0,\n        startTime: new Date().toISOString()\n    };\n    productStats.errors++;\n    global.set('productServiceStats', productStats);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 240,
        "wires": [["filter-response"]]
    },
    {
        "id": "filter-error-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Filter Error Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 680,
        "y": 300,
        "wires": []
    },
    {
        "id": "filter-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Filter Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1130,
        "y": 240,
        "wires": []
    },
    {
        "id": "product-categories-endpoint",
        "type": "http in",
        "z": "product-service-flows",
        "name": "GET /api/products/categories",
        "url": "/api/products/categories",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 320,
        "wires": [["forward-to-categories"]]
    },
    {
        "id": "forward-to-categories",
        "type": "http request",
        "z": "product-service-flows",
        "name": "â†’ Get Categories API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-product-1:3002/filter/categories",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 410,
        "y": 320,
        "wires": [["process-categories-response"]]
    },
    {
        "id": "process-categories-response",
        "type": "function",
        "z": "product-service-flows",
        "name": "Process Categories Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\n\nif (isSuccess && msg.payload && msg.payload.success && Array.isArray(msg.payload.data)) {\n    const categories = msg.payload.data;\n    \n    node.log(`âœ… SUCCESS: Retrieved ${categories.length} categories`);\n    \n    // Return categories in consistent format\n    msg.payload = categories;\n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Categories retrieval failed - Status: ${msg.statusCode}`);\n    \n    msg.payload = {\n        success: false,\n        message: 'Failed to retrieve categories',\n        error: msg.payload.error || 'Unknown error'\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 320,
        "wires": [["categories-response"]]
    },
    {
        "id": "categories-response",
        "type": "http response",
        "z": "product-service-flows",
        "name": "Categories Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 940,
        "y": 320,
        "wires": []
    },
    {
        "id": "product-stats-monitor",
        "type": "inject",
        "z": "product-service-flows",
        "name": "ðŸ“Š Product Stats Monitor",
        "props": [{"p": "payload"}],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "20",
        "topic": "product-stats",
        "payload": "",
        "payloadType": "date",
        "x": 170,
        "y": 400,
        "wires": [["collect-product-stats"]]
    },
    {
        "id": "collect-product-stats",
        "type": "function",
        "z": "product-service-flows",
        "name": "Collect Product Statistics",
        "func": "// Get or initialize product stats\nlet productStats = global.get('productServiceStats') || {\n    getAllRequests: 0,\n    getByIdRequests: 0,\n    filterRequests: 0,\n    errors: 0,\n    startTime: new Date().toISOString()\n};\n\n// Calculate uptime\nconst startTime = new Date(productStats.startTime);\nconst uptime = Math.round((new Date() - startTime) / 1000 / 60); // minutes\n\n// Calculate total requests\nconst totalRequests = productStats.getAllRequests + productStats.getByIdRequests + productStats.filterRequests;\n\nconst statsReport = {\n    service: 'Product Service',\n    timestamp: new Date().toISOString(),\n    uptime: `${uptime} minutes`,\n    statistics: {\n        totalRequests: totalRequests,\n        getAllProductsRequests: productStats.getAllRequests,\n        getProductByIdRequests: productStats.getByIdRequests,\n        filterProductsRequests: productStats.filterRequests,\n        errors: productStats.errors\n    },\n    healthStatus: 'monitoring'\n};\n\nnode.log(`ðŸ“Š PRODUCT SERVICE STATS: ${totalRequests} total requests (GetAll: ${productStats.getAllRequests}, GetById: ${productStats.getByIdRequests}, Filter: ${productStats.filterRequests})`);\n\nmsg.payload = statsReport;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 400,
        "wires": [["product-stats-debug"]]
    },
    {
        "id": "product-stats-debug",
        "type": "debug",
        "z": "product-service-flows",
        "name": "ðŸ“Š Product Service Stats",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 400,
        "wires": []
    }
]