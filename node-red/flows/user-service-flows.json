[
    {
        "id": "user-service-flows",
        "type": "tab",
        "label": "ðŸ‘¤ User Service Gateway",
        "disabled": false,
        "info": "Complete User Service API Gateway based on actual controllers"
    },
    {
        "id": "user-register-endpoint",
        "type": "http in",
        "z": "user-service-flows",
        "name": "POST /api/users/register",
        "url": "/api/users/register",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 80,
        "wires": [["validate-registration-data"]]
    },
    {
        "id": "validate-registration-data",
        "type": "function",
        "z": "user-service-flows",
        "name": "Validate Registration Data",
        "func": "const { email, password, firstName, lastName, age, phone, gender } = msg.payload;\n\n// Log registration attempt\nnode.log(`ðŸ”¥ REGISTRATION ATTEMPT: ${email}`);\n\n// Validate required fields\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'Email and password are required' };\n    return [null, msg]; // Send to error response\n}\n\n// Validate email format\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(email)) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'Invalid email format' };\n    return [null, msg];\n}\n\n// Validate password strength\nif (password.length < 6) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'Password must be at least 6 characters' };\n    return [null, msg];\n}\n\nnode.log(`âœ… VALIDATION PASSED for ${email}`);\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 80,
        "wires": [["forward-to-user-register"], ["registration-error-response"]]
    },
    {
        "id": "forward-to-user-register",
        "type": "http request",
        "z": "user-service-flows",
        "name": "â†’ User Registration API",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-user-1:3001/users",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {"Content-Type": "application/json"},
        "x": 650,
        "y": 60,
        "wires": [["process-registration-response"]]
    },
    {
        "id": "process-registration-response",
        "type": "function",
        "z": "user-service-flows",
        "name": "Process Registration Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\nconst email = msg.req._data ? JSON.parse(msg.req._data).email : 'Unknown';\n\nif (isSuccess) {\n    node.log(`âœ… SUCCESS: User ${email} registered! User ID: ${msg.payload}`);\n    \n    // Create success response\n    msg.payload = {\n        success: true,\n        message: 'User registered successfully',\n        userId: msg.payload,\n        timestamp: new Date().toISOString()\n    };\n} else {\n    node.warn(`âŒ FAILED: Registration failed for ${email} - Status: ${msg.statusCode}`);\n    \n    // Handle existing user or other errors\n    if (msg.statusCode === 400 && msg.payload.message === 'user already exists') {\n        msg.payload = {\n            success: false,\n            message: 'User already exists with this email',\n            error: 'DUPLICATE_EMAIL'\n        };\n    } else {\n        msg.payload = {\n            success: false,\n            message: 'Registration failed',\n            error: msg.payload.message || 'Unknown error'\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 60,
        "wires": [["registration-response"]]
    },
    {
        "id": "registration-error-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Registration Error Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 680,
        "y": 120,
        "wires": []
    },
    {
        "id": "registration-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Registration Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1180,
        "y": 60,
        "wires": []
    },
    {
        "id": "user-login-endpoint",
        "type": "http in",
        "z": "user-service-flows",
        "name": "POST /api/users/login",
        "url": "/api/users/login",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 200,
        "wires": [["validate-login-data"]]
    },
    {
        "id": "validate-login-data",
        "type": "function",
        "z": "user-service-flows",
        "name": "Validate Login Data",
        "func": "const { email, password } = msg.payload;\n\n// Log login attempt\nnode.log(`ðŸ” LOGIN ATTEMPT: ${email}`);\n\n// Validate required fields\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'Email and password are required' };\n    return [null, msg]; // Send to error response\n}\n\nnode.log(`âœ… LOGIN VALIDATION PASSED for ${email}`);\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 200,
        "wires": [["forward-to-user-login"], ["login-error-response"]]
    },
    {
        "id": "forward-to-user-login",
        "type": "http request",
        "z": "user-service-flows",
        "name": "â†’ User Login API",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-user-1:3001/users/login",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {"Content-Type": "application/json"},
        "x": 620,
        "y": 180,
        "wires": [["process-login-response"]]
    },
    {
        "id": "process-login-response",
        "type": "function",
        "z": "user-service-flows",
        "name": "Process Login Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\nconst email = msg.req._data ? JSON.parse(msg.req._data).email : 'Unknown';\n\nif (isSuccess && msg.payload) {\n    // Your controller returns the JWT token directly as a string\n    const token = msg.payload;\n    \n    node.log(`âœ… SUCCESS: User ${email} logged in! Token generated.`);\n    \n    // Store token globally for other Node-RED flows to use\n    global.set('lastLoginToken', token);\n    global.set('lastLoginUser', email);\n    \n    // Create structured response\n    msg.payload = {\n        success: true,\n        message: 'Login successful',\n        token: token,\n        timestamp: new Date().toISOString()\n    };\n    \n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Login failed for ${email} - Status: ${msg.statusCode}`);\n    \n    if (msg.statusCode === 401) {\n        msg.payload = {\n            success: false,\n            message: 'Invalid email or password',\n            error: 'INVALID_CREDENTIALS'\n        };\n    } else {\n        msg.payload = {\n            success: false,\n            message: 'Login failed',\n            error: msg.payload.message || 'Unknown error'\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 180,
        "wires": [["login-response"]]
    },
    {
        "id": "login-error-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Login Error Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 650,
        "y": 240,
        "wires": []
    },
    {
        "id": "login-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Login Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1130,
        "y": 180,
        "wires": []
    },
    {
        "id": "user-profile-endpoint",
        "type": "http in",
        "z": "user-service-flows",
        "name": "GET /api/users/profile",
        "url": "/api/users/profile",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 320,
        "wires": [["validate-auth-token"]]
    },
    {
        "id": "user-get-profile-endpoint",
        "type": "http in",
        "z": "user-service-flows",
        "name": "GET /api/users",
        "url": "/api/users",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 380,
        "wires": [["validate-auth-token-alt"]]
    },
    {
        "id": "validate-auth-token",
        "type": "function",
        "z": "user-service-flows",
        "name": "Validate Auth Token",
        "func": "const authHeader = msg.req.headers.authorization || msg.req.headers.Authorization;\n\nnode.log(`ðŸ” PROFILE ACCESS ATTEMPT`);\n\n// Check if Authorization header exists\nif (!authHeader) {\n    node.warn(`âŒ No Authorization header provided`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Authorization header required',\n        error: 'NO_AUTH_HEADER'\n    };\n    return [null, msg]; // Send to error response\n}\n\n// Check if it's a Bearer token\nif (!authHeader.startsWith('Bearer ')) {\n    node.warn(`âŒ Invalid Authorization header format`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Invalid authorization format. Use Bearer token',\n        error: 'INVALID_AUTH_FORMAT'\n    };\n    return [null, msg];\n}\n\nconst token = authHeader.split(' ')[1];\nif (!token) {\n    node.warn(`âŒ No token provided`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Token required',\n        error: 'NO_TOKEN'\n    };\n    return [null, msg];\n}\n\nnode.log(`âœ… AUTH TOKEN VALIDATION PASSED`);\n\n// Forward the authorization header to the user service\nmsg.headers = {\n    'Authorization': authHeader\n};\n\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 320,
        "wires": [["forward-to-user-profile"], ["profile-error-response"]]
    },
    {
        "id": "validate-auth-token-alt",
        "type": "function",
        "z": "user-service-flows",
        "name": "Validate Auth Token (Alt)",
        "func": "const authHeader = msg.req.headers.authorization || msg.req.headers.Authorization;\n\nnode.log(`ðŸ” USER PROFILE ACCESS (/api/users)`);\n\n// Check if Authorization header exists\nif (!authHeader) {\n    node.warn(`âŒ No Authorization header provided`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Authorization header required',\n        error: 'NO_AUTH_HEADER'\n    };\n    return [null, msg]; // Send to error response\n}\n\n// Check if it's a Bearer token\nif (!authHeader.startsWith('Bearer ')) {\n    node.warn(`âŒ Invalid Authorization header format`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Invalid authorization format. Use Bearer token',\n        error: 'INVALID_AUTH_FORMAT'\n    };\n    return [null, msg];\n}\n\nconst token = authHeader.split(' ')[1];\nif (!token) {\n    node.warn(`âŒ No token provided`);\n    msg.statusCode = 401;\n    msg.payload = { \n        success: false,\n        message: 'Token required',\n        error: 'NO_TOKEN'\n    };\n    return [null, msg];\n}\n\nnode.log(`âœ… AUTH TOKEN VALIDATION PASSED for /api/users`);\n\n// Forward the authorization header to the user service\nmsg.headers = {\n    'Authorization': authHeader\n};\n\nreturn [msg, null]; // Send to success flow",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 380,
        "wires": [["forward-to-user-profile-alt"], ["profile-error-response-alt"]]
    },
    {
        "id": "forward-to-user-profile",
        "type": "http request",
        "z": "user-service-flows",
        "name": "â†’ User Profile API",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-user-1:3001/users",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 640,
        "y": 300,
        "wires": [["process-profile-response"]]
    },
    {
        "id": "forward-to-user-profile-alt",
        "type": "http request",
        "z": "user-service-flows",
        "name": "â†’ User Profile API (Alt)",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://e-commerce_web_application-user-1:3001/users",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "senderr": false,
        "headers": {},
        "x": 660,
        "y": 360,
        "wires": [["process-profile-response-alt"]]
    },
    {
        "id": "process-profile-response",
        "type": "function",
        "z": "user-service-flows",
        "name": "Process Profile Response",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\n\nif (isSuccess && msg.payload) {\n    const userProfile = msg.payload;\n    \n    node.log(`âœ… SUCCESS: Profile data retrieved for user ID: ${userProfile._id}`);\n    \n    // Create structured response with user profile\n    msg.payload = {\n        success: true,\n        message: 'Profile retrieved successfully',\n        user: {\n            id: userProfile._id,\n            email: userProfile.email,\n            firstName: userProfile.firstName,\n            lastName: userProfile.lastName,\n            age: userProfile.age,\n            phone: userProfile.phone,\n            gender: userProfile.gender\n        },\n        timestamp: new Date().toISOString()\n    };\n    \n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Profile access failed - Status: ${msg.statusCode}`);\n    \n    if (msg.statusCode === 401) {\n        msg.payload = {\n            success: false,\n            message: 'Invalid or expired token',\n            error: 'INVALID_TOKEN'\n        };\n    } else {\n        msg.payload = {\n            success: false,\n            message: 'Profile access failed',\n            error: msg.payload.message || 'Unknown error'\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 300,
        "wires": [["profile-response"]]
    },
    {
        "id": "process-profile-response-alt",
        "type": "function",
        "z": "user-service-flows",
        "name": "Process Profile Response (Alt)",
        "func": "const isSuccess = msg.statusCode >= 200 && msg.statusCode < 300;\n\nif (isSuccess && msg.payload) {\n    const userProfile = msg.payload;\n    \n    node.log(`âœ… SUCCESS: Profile data retrieved via /api/users for user ID: ${userProfile._id}`);\n    \n    // Return the user profile directly to match frontend expectations\n    msg.payload = {\n        _id: userProfile._id,\n        email: userProfile.email,\n        firstName: userProfile.firstName,\n        lastName: userProfile.lastName,\n        age: userProfile.age,\n        phone: userProfile.phone,\n        gender: userProfile.gender\n    };\n    \n    msg.statusCode = 200;\n} else {\n    node.warn(`âŒ FAILED: Profile access failed via /api/users - Status: ${msg.statusCode}`);\n    \n    if (msg.statusCode === 401) {\n        msg.payload = {\n            success: false,\n            message: 'Invalid or expired token',\n            error: 'INVALID_TOKEN'\n        };\n    } else {\n        msg.payload = {\n            success: false,\n            message: 'Profile access failed',\n            error: msg.payload.message || 'Unknown error'\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 360,
        "wires": [["profile-response-alt"]]
    },
    {
        "id": "profile-error-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Profile Error Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 670,
        "y": 360,
        "wires": []
    },
    {
        "id": "profile-error-response-alt",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Profile Error Response (Alt)",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 690,
        "y": 420,
        "wires": []
    },
    {
        "id": "profile-response",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Profile Response",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1150,
        "y": 300,
        "wires": []
    },
    {
        "id": "profile-response-alt",
        "type": "http response",
        "z": "user-service-flows",
        "name": "Profile Response (Alt)",
        "statusCode": "",
        "headers": {"Content-Type": "application/json"},
        "x": 1170,
        "y": 360,
        "wires": []
    },
    {
        "id": "user-stats-monitor",
        "type": "inject",
        "z": "user-service-flows",
        "name": "ðŸ“Š User Stats Monitor",
        "props": [{"p": "payload"}],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "user-stats",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 440,
        "wires": [["collect-user-stats"]]
    },
    {
        "id": "collect-user-stats",
        "type": "function",
        "z": "user-service-flows",
        "name": "Collect User Statistics",
        "func": "// Get or initialize user stats\nlet userStats = global.get('userServiceStats') || {\n    registrations: 0,\n    logins: 0,\n    profileAccesses: 0,\n    errors: 0,\n    lastActivity: null,\n    activeUsers: [],\n    startTime: new Date().toISOString()\n};\n\n// Calculate uptime\nconst startTime = new Date(userStats.startTime);\nconst uptime = Math.round((new Date() - startTime) / 1000 / 60); // minutes\n\n// Get last login info\nconst lastLoginUser = global.get('lastLoginUser');\nconst lastLoginToken = global.get('lastLoginToken');\n\nconst statsReport = {\n    service: 'User Service',\n    timestamp: new Date().toISOString(),\n    uptime: `${uptime} minutes`,\n    statistics: userStats,\n    lastLogin: {\n        user: lastLoginUser || 'None',\n        hasToken: lastLoginToken ? true : false\n    },\n    healthStatus: 'monitoring'\n};\n\nnode.log(`ðŸ“Š USER SERVICE STATS: ${userStats.registrations} registrations, ${userStats.logins} logins, ${userStats.profileAccesses} profile accesses`);\n\nmsg.payload = statsReport;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 440,
        "wires": [["user-stats-debug"]]
    },
    {
        "id": "user-stats-debug",
        "type": "debug",
        "z": "user-service-flows",
        "name": "ðŸ“Š User Service Stats",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 680,
        "y": 440,
        "wires": []
    }
]